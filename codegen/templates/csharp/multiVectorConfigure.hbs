using Weaviate.Client.Models;
using static Weaviate.Client.Models.VectorIndexConfig;

namespace Weaviate.Client;

public static partial class Configure
{
    public static class MultiVectors
    {
        public static VectorConfigBuilder SelfProvided() => new(new Vectorizer.SelfProvided());

        public class VectorConfigBuilder(VectorizerConfig Config)
        {
            public VectorConfig New(
                string name = "default",
                VectorIndex.HNSW? indexConfig = null,
                QuantizerConfigBase? quantizerConfig = null,
                params string[] sourceProperties
            )
            {
                indexConfig ??= new VectorIndex.HNSW()
                {
                    MultiVector = new VectorIndexConfig.MultiVectorConfig(),
                };

                indexConfig.MultiVector ??= new VectorIndexConfig.MultiVectorConfig();

                if (quantizerConfig is not null && indexConfig.Quantizer is not null)
                {
                    throw new WeaviateClientException(
                        new InvalidOperationException(
                            "Quantizer is already set on the indexConfig. Please provide either the quantizerConfig or set it on the indexConfig, not both."
                        )
                    );
                }

                return new(
                    name,
                    vectorizer: Config with
                    {
                        SourceProperties = sourceProperties,
                    },
                    vectorIndexConfig: quantizerConfig is null
                        ? indexConfig
                        : indexConfig with
                        {
                            Quantizer = quantizerConfig,
                        }
                );
            }
        }
{{#each vectorizers}}
{{#if (shouldGenerateFactory name "MultiVectors")}}

        public static VectorConfigBuilder {{name}}({{#if properties.length}}
{{#each (getParameterOrder this)}}
            {{nullableType this}} {{toCamelCase name}}{{#if required}}{{else}} = null{{/if}}{{#unless @last}},{{/unless}}
{{/each}}
        {{else}}) {{/if}}=>
            new(
                new Vectorizer.{{name}}{{#if properties.length}}
                {
{{#each (getParameterOrder this)}}
                    {{name}} = {{toCamelCase name}}{{#unless @last}},{{/unless}}
{{/each}}
                }{{else}} { }{{/if}}
            );
{{/if}}
{{/each}}
    }
}
